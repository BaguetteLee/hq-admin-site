<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum=1">
  <title>总部管理系统 - 任务全局管理（v13）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{--primary:#3b7ddd;--primary-light:#e8f0fe;--red:#dc3545;--white:#ffffff;--light:#f5f6f8;--border:#e2e8f0;--text:#2d3748;--dot-platform:#3b7ddd;--dot-user:#2fb67b;--dot-team:#f6a035;--dot-system:#7a5af8;}
    body{background-color:var(--light);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:var(--text);}
    .sidebar{background-color:var(--white);color:#4a5568;height:100vh;position:fixed;left:0;top:0;width:260px;padding-top:60px;box-shadow:2px 0 10px rgba(0,0,0,0.05);border-right:1px solid var(--border);z-index:1000;overflow-y:auto;}
    .sidebar .nav-link{color:#4a5568;padding:.8rem 1rem;margin:.1rem .5rem;border-radius:6px;transition:all .2s;display:flex;align-items:center;gap:.55rem;}
    .sidebar .nav-link i{color:#718096;}
    .sidebar .nav-link:hover,.sidebar .nav-link.active{color:var(--primary);background-color:var(--primary-light);}
    .sidebar .nav-link.active i,.sidebar .nav-link:hover i{color:var(--primary);}
    .sidebar .menu-section{padding:.75rem 1rem .25rem;color:#94a3b8;font-weight:700;text-transform:uppercase;font-size:.75rem;letter-spacing:.06em;}
    .cat-dot{display:inline-block;width:.6rem;height:.6rem;border-radius:2px;flex:0 0 auto;}
    .dot-platform{background-color:var(--dot-platform);} .dot-user{background-color:var(--dot-user);} .dot-team{background-color:var(--dot-team);} .dot-system{background-color:var(--dot-system);}
    .navbar{background-color:var(--white);box-shadow:0 2px 10px rgba(0,0,0,.05);border-bottom:1px solid var(--border);position:fixed;top:0;left:0;right:0;z-index:1030;padding-left:260px;transition:padding-left .3s;}
    .navbar-brand{color:var(--primary);font-weight:700;display:flex;align-items:center;gap:.6rem;}
    .navbar-toggler{display:none;border:none;font-size:1.25rem;}
    .navbar-toggler:focus{box-shadow:none;}
    .main-content{margin-left:260px;padding:20px;padding-top:80px;transition:margin-left .3s;}
    @media (max-width: 992px){.sidebar{width:84px;padding-top:70px;} .sidebar .nav-link span.text{display:none;} .sidebar .menu-section{display:none;} .main-content{margin-left:84px;} .navbar{padding-left:84px;}}
    @media (max-width: 768px){.sidebar{transform:translateX(-100%);width:260px;} .sidebar.show{transform:translateX(0);} .main-content{margin-left:0;} .navbar{padding-left:15px;} .navbar-toggler{display:block;}}
    .dashboard-card{background:var(--white);border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.05);border:none;margin-bottom:18px;}
    .table th{font-weight:600;color:#4a5568;border-bottom:2px solid var(--border);}
    .table-hover tbody tr:hover{background-color:#f8fafc;}
    .progress{height:8px}
    .countdown{font-variant-numeric:tabular-nums}
    .badge-wait{background:#eff6ff;border:1px solid #bfdbfe;color:#1d4ed8;border-radius:8px;padding:.25rem .5rem;}
    .badge-reject{background:#fff1f2;border:1px solid #fecdd3;color:#b91c1c;border-radius:8px;padding:.25rem .5rem;}
    .badge-run{background:#e8fff3;border:1px solid #b7f0cc;color:#166534;border-radius:8px;padding:.25rem .5rem;}
    .badge-done{background:#f3f4f6;border:1px solid #e5e7eb;color:#374151;border-radius:8px;padding:.25rem .5rem;}
    .table-fixed{table-layout:fixed;}
    .text-compact{font-size:13.5px;line-height:1.28;}
    .cell-tight{font-size:13px;line-height:1.2}
    .truncate{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .col-id{width:140px}.col-cat{width:150px}.col-user{width:130px}.col-progress{width:200px}.col-status{width:110px}.col-audit{width:230px}.col-amount{width:160px}.col-countdown{width:110px}.col-ops{width:200px}
    .drawer{position:fixed;right:-720px;top:56px;bottom:0;width:720px;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(0,0,0,.08);transition:right .25s;z-index:1050;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .drawer-body{padding:16px;overflow:auto}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:.4rem 1rem;align-items:center}
    .kv .k{color:#64748b}
    .kv .v{font-weight:600}
    .flow-drawer{position:fixed;right:-900px;top:56px;bottom:0;width:900px;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(0,0,0,.08);transition:right .25s;z-index:1060;display:flex;flex-direction:column}
    .flow-drawer.open{right:0}
    .flow-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .flow-body{padding:16px;overflow:auto}
    .flow-toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.75rem}
    .chip{padding:.25rem .55rem;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer;font-size:.85rem}
    .chip.active{background:#e8f0fe;border-color:#c7d2fe;color:#1d4ed8}
    .timeline{border-left:3px solid var(--border);padding-left:12px;margin-left:6px}
    .timeline .item{position:relative;margin-bottom:.9rem}
    .timeline .item::before{content:'';position:absolute;left:-10px;top:.35rem;width:8px;height:8px;border-radius:50%;background:#1d4ed8}
    .tl-meta{color:#64748b}
    .tl-tag{display:inline-flex;align-items:center;gap:.25rem;border:1px solid #e5e7eb;border-radius:999px;padding:.1rem .4rem;font-size:.75rem;margin-right:.25rem}
    .tl-amount{font-weight:700}
    #debugBar{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);color:#fff;padding:6px 10px;font-size:12px;z-index:5000;display:none}
    .table-sm>:not(caption)>*>*{padding:.28rem .35rem;}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" id="sidebarToggle"><span class="navbar-toggler-icon"></span></button>
      <a class="navbar-brand" href="#"><strong><i class="bi bi-building me-2"></i>总部管理系统</strong></a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto me-5">
          <li class="nav-item dropdown ms-2">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle me-2"></i> 管理员
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="btnLogout"><i class="bi bi-box-arrow-right me-2"></i>退出</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <aside class="sidebar">
        <div class="position-sticky">
            <ul class="nav flex-column">
                <!-- 平台层面 -->
                <li class="menu-section">平台</li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-dashboard.html">
                        <span class="cat-dot dot-platform"></span><i class="bi bi-speedometer2"></i><span class="text">平台总仪表盘</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-finance-platform-fund-flow.html">
                        <span class="cat-dot dot-platform"></span><i class="bi bi-currency-exchange"></i><span class="text">平台资金流水</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="hq-admin-tasks-global-management.html">
                        <span class="cat-dot dot-platform"></span><i class="bi bi-list-task"></i><span class="text">任务全局管理</span>
                    </a>
                </li>

                <!-- 用户层面 -->
                <li class="menu-section">用户</li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-users-list.html">
                        <span class="cat-dot dot-user"></span><i class="bi bi-people"></i><span class="text">平台用户列表</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-finance-recharge-review.html">
                        <span class="cat-dot dot-user"></span><i class="bi bi-wallet2"></i><span class="text">用户充值审核</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-finance-withdrawal-review.html">
                        <span class="cat-dot dot-user"></span><i class="bi bi-cash-coin"></i><span class="text">用户提现审核</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-finance-user-fund-flow.html">
                        <span class="cat-dot dot-user"></span><i class="bi bi-currency-exchange"></i><span class="text">用户资金流水</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-users-feedback.html">
                        <span class="cat-dot dot-user"></span><i class="bi bi-chat-left-text"></i><span class="text">用户投诉反馈</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-audit-task-publish.html">
                        <span class="cat-dot dot-user"></span><i class="bi bi-send-check"></i><span class="text">用户发布审核</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-audit-task-completion.html">
                        <span class="cat-dot dot-user"></span><i class="bi bi-check2-circle"></i><span class="text">任务完成审核</span>
                    </a>
                </li>

                <!-- 团队层面 -->
                <li class="menu-section">团队</li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-team-dashboard.html">
                        <span class="cat-dot dot-team"></span><i class="bi bi-graph-up"></i><span class="text">团队数据概览</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-team-list.html">
                        <span class="cat-dot dot-team"></span><i class="bi bi-building"></i><span class="text">平台团队列表</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-finance-team-withdrawal-review.html">
                        <span class="cat-dot dot-team"></span><i class="bi bi-bank"></i><span class="text">团队提现审核</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-finance-team-fund-flow.html">
                        <span class="cat-dot dot-team"></span><i class="bi bi-currency-exchange"></i><span class="text">团队资金流水</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-team-feedback.html">
                        <span class="cat-dot dot-team"></span><i class="bi bi-chat-left-text"></i><span class="text">团队投诉反馈</span>
                    </a>
                </li>

                <!-- 系统设置层面 -->
                <li class="menu-section">系统</li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-settings-categories.html">
                        <span class="cat-dot dot-system"></span><i class="bi bi-tags"></i><span class="text">业务分类管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-system-api-management-monitoring.html">
                        <span class="cat-dot dot-system"></span><i class="bi bi-hdd-network"></i><span class="text">接口管理监控</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="hq-admin-settings-system.html">
                        <span class="cat-dot dot-system"></span><i class="bi bi-gear-fill"></i><span class="text">系统设置</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>


  <main class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="mb-0">任务全局管理</h4>
    </div>

    <div class="dashboard-card card">
      <div class="card-body d-flex flex-wrap align-items-center">
        <div class="me-3"><i class="bi bi-exclamation-octagon me-1 text-danger"></i> 异议中：<b id="kpiDispute">0</b></div>
        <div class="me-3"><i class="bi bi-tools me-1"></i> 处理中：<b id="kpiProcessing">0</b></div>
        <div class="me-3"><i class="bi bi-send-check me-1"></i> 待发布审核：<b id="kpiPubAudit">0</b></div>
        <div class="me-3"><i class="bi bi-check2-circle me-1"></i> 待完成审核：<b id="kpiCompAudit">0</b></div>
        <div class="me-3"><i class="bi bi-hourglass-split me-1"></i> 进行中任务：<b id="kpiRunning">0</b></div>
      </div>
    </div>

    <div class="dashboard-card card">
      <div class="card-body">
        <form id="filterForm" class="row g-3 align-items-end">
          <div class="col-md-3"><label class="form-label">关键词</label><input type="text" class="form-control" id="kw" placeholder="任务ID / 发布用户ID"></div>
          <div class="col-md-2"><label class="form-label">任务分类</label><select class="form-select" id="category"><option value="">全部</option><option>短视频点赞</option><option>短视频关注</option><option>电商收藏</option><option>电商加购</option><option>应用安装</option></select></div>
          <div class="col-md-2"><label class="form-label">平台层级状态</label><select class="form-select" id="platStatus"><option value="">全部</option><option value="待审核">待审核</option><option value="被驳回">被驳回</option><option value="进行中">进行中</option><option value="已完成">已完成</option></select></div>
          <div class="col-md-2"><label class="form-label">创建时间（起）</label><input type="date" class="form-control" id="dateFrom" autocomplete="off"></div>
          <div class="col-md-2"><label class="form-label">创建时间（止）</label><input type="date" class="form-control" id="dateTo" autocomplete="off"></div>
          <div class="col-md-2"><label class="form-label">排序</label><select class="form-select" id="sortBy"><option value="recent">最近创建</option><option value="completion">完成率</option><option value="remain">剩余名额</option><option value="amount">金额（总赏金）</option></select></div>
          
          <div class="col-md-4 text-end ms-auto">
            <button type="button" class="btn btn-primary" id="btnApply"><i class="bi bi-funnel me-1"></i>应用筛选</button>
            <button type="button" class="btn btn-outline-secondary ms-2" id="btnReset">重置</button>
            <button type="button" class="btn btn-outline-primary ms-2" id="btnExport"><i class="bi bi-download me-1"></i>导出 CSV</button>
          </div>
        </form>
      </div>
    </div>

    <div class="dashboard-card card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>任务列表（<span id="totalCount">0</span>）</div>
        <div class="small text-muted">每页 15 条</div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-sm align-middle mb-0 table-fixed text-compact">
            <colgroup>
              <col class="col-id"/><col class="col-cat"/><col class="col-user"/><col class="col-progress"/>
              <col class="col-status"/><col class="col-audit"/><col class="col-amount"/><col class="col-countdown"/><col class="col-ops"/>
            </colgroup>
            <thead>
              <tr>
                <th>任务ID</th><th>任务分类</th><th>发布用户</th><th>额度进度</th><th>平台层级状态</th><th>审核与争议</th><th>金额</th><th>结束倒计时</th><th>操作</th>
              </tr>
            </thead>
            <tbody id="taskTbody"></tbody>
          </table>
        </div>
      </div>
      <div class="card-body">
        <nav class="d-flex justify-content-center"><ul class="pagination mb-0" id="pager"></ul></nav>
      </div>
    </div>
  </main>

  <div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">任务整体详情</h6>
          <span id="tmStatusBadge" class="badge-wait ms-2">—</span>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><div class="small text-muted">任务ID</div><div class="fw-semibold" id="tmTaskId">—</div></div>
            <div class="col-md-6"><div class="small text-muted">平台 / 分类</div><div class="fw-semibold" id="tmPlatCat">—</div></div>
            <div class="col-md-6"><div class="small text-muted">发布用户</div><div class="fw-semibold" id="tmPublisher">—</div></div>
            <div class="col-md-6"><div class="small text-muted">创建时间</div><div class="fw-semibold" id="tmCreated">—</div></div>
            <div class="col-md-6"><div class="small text-muted">截止时间</div><div class="fw-semibold" id="tmDeadline">—</div></div>
            <div class="col-md-6"><div class="small text-muted">状态 / 完成率</div><div class="fw-semibold" id="tmStatus">—</div></div>
            <div class="col-md-6"><div class="small text-muted">额度 / 完成</div><div class="fw-semibold" id="tmQuota">—</div></div>
            <div class="col-md-6"><div class="small text-muted">单份赏金 / 预计总赏金</div><div class="fw-semibold" id="tmBounty">—</div></div>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button></div>
      </div>
    </div>
  </div>

  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="d-flex align-items-center gap-2"><h6 class="mb-0">任务详情</h6> <span id="dPlatStatus" class="badge-wait">—</span></div>
      <div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-outline-secondary" id="btnCloseDrawer"><i class="bi bi-x-lg"></i></button></div>
    </div>
    <div class="drawer-body">
      <div class="kv mb-3">
        <div class="k">任务ID</div><div class="v" id="dTaskId">—</div>
        <div class="k">分类/平台</div><div class="v" id="dCatPlat">—</div>
        <div class="k">发布用户</div><div class="v" id="dPublisher">—</div>
        <div class="k">额度进度</div><div class="v"><span id="dProgressText">—</span><div class="progress mt-1"><div class="progress-bar" id="dProgressBar" style="width:0%"></div></div></div>
      </div>
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview">概览</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-progress">任务日志</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-audit">作业审核</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-fund">资金流水</button></li>
      </ul>
      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="tab-overview">
          <div class="kv">
            <div class="k">任务平台</div><div class="v" id="ovPlatform">—</div>
            <div class="k">任务分类</div><div class="v" id="ovCategory">—</div>
            <div class="k">创建时间</div><div class="v" id="ovCreated">—</div>
            <div class="k">发布表单摘要</div><div class="v" id="ovFormSummary">—</div>
          </div>
        </div>
        <div class="tab-pane fade" id="tab-progress"><div id="progressTimeline" class="small"></div></div>
        <div class="tab-pane fade" id="tab-audit"><div id="auditTimeline" class="small text-muted">（根据任务状态动态生成时间线）</div></div>
        <div class="tab-pane fade" id="tab-fund">
          <div class="kv">
            <div class="k">总赏金</div><div class="v" id="fdBounty">—</div>
            <div class="k">发布信息费</div><div class="v" id="fdInfoFee">—</div>
            <div class="k">分成（执行/管理）</div><div class="v" id="fdShare">—</div>
            <div class="k">已结/待退</div><div class="v" id="fdSettle">—</div>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <aside class="flow-drawer" id="flowDrawer">
    <div class="flow-head">
      <div class="d-flex align-items-center gap-2"><h6 class="mb-0">任务流水</h6><span class="text-muted small" id="flowTitle">—</span></div>
      <div class="d-flex align-items-center gap-2"><input type="text" id="flowSearch" class="form-control form-control-sm" placeholder="搜索流水关键字…"><button class="btn btn-sm btn-outline-secondary" id="btnCloseFlow"><i class="bi bi-x-lg"></i></button></div>
    </div>
    <div class="flow-body">
      <div class="card mb-2">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2"><span id="flowStatusBadge" class="badge-wait">—</span><span id="flowStatusText" class="fw-semibold">—</span></div>
            <div class="small text-muted" id="flowProgressText">—</div>
          </div>
          <div class="progress mt-2"><div class="progress-bar" id="flowProgressBar" style="width:0%"></div></div>
        </div>
      </div>
      <div class="flow-toolbar">
        <span class="chip active" data-type="all">全部</span><span class="chip" data-type="tasklog">任务日志</span><span class="chip" data-type="audit">作业审核</span><span class="chip" data-type="fund">资金</span>
      </div>
      <div class="timeline" id="flowTimeline"></div>
    </div>
  </aside>

  <div class="modal fade" id="forceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title"><i class="bi bi-power text-danger me-2"></i>强行终止任务</h6><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
          <p class="mb-2 text-muted small">为防止误操作，请填写<strong>不低于 10 个字</strong>的终止原因。该原因会记录到“任务日志”与“资金流水”。</p>
          <textarea id="forceReason" class="form-control" rows="4" placeholder="示例：发布方撤单，因素材违规且无法在时限内修复……"></textarea>
          <div class="form-text" id="forceHint"></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-danger" id="forceConfirmBtn">确认终止</button></div>
      </div>
    </div>
  </div>

  <div id="debugBar"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const TASKS = [
      {"id":"T20250912001","category":"短视频点赞","platform":"抖音","publisher":"U10086","total":500,"done":320,"status":"running","pubAudit":"passed","compAuditing":18,"disputes":{"in":6,"processing":2},"bountyPer":1.0,"serviceFeeRate":0.12,"shareMgmt":0.1,"createdAt":"2025-09-10T09:00:00Z","deadlineHours":72,"rejectReason":""},
      {"id":"T20250912002","category":"短视频关注","platform":"快手","publisher":"U20001","total":200,"done":200,"status":"closed","pubAudit":"passed","compAuditing":0,"disputes":{"in":0,"processing":0},"bountyPer":0.8,"serviceFeeRate":0.10,"shareMgmt":0.08,"createdAt":"2025-09-09T13:20:00Z","deadlineHours":24,"rejectReason":""},
      {"id":"T20250912003","category":"电商收藏","platform":"淘宝","publisher":"U30012","total":1000,"done":0,"status":"draft","pubAudit":"pending","compAuditing":0,"disputes":{"in":0,"processing":0},"bountyPer":0.5,"serviceFeeRate":0.15,"shareMgmt":0.1,"createdAt":"2025-09-12T02:10:00Z","deadlineHours":48,"rejectReason":""},
      {"id":"T20250912004","category":"电商加购","platform":"京东","publisher":"U88888","total":300,"done":80,"status":"paused","pubAudit":"passed","compAuditing":9,"disputes":{"in":3,"processing":1},"bountyPer":1.5,"serviceFeeRate":0.12,"shareMgmt":0.12,"createdAt":"2025-09-11T15:00:00Z","deadlineHours":72,"rejectReason":""},
      {"id":"T20250912005","category":"应用安装","platform":"小红书","publisher":"U55555","total":150,"done":0,"status":"draft","pubAudit":"rejected","compAuditing":0,"disputes":{"in":0,"processing":0},"bountyPer":1.2,"serviceFeeRate":0.10,"shareMgmt":0.1,"createdAt":"2025-09-12T04:00:00Z","deadlineHours":48,"rejectReason":"应用来源渠道未验证，描述不清"}
    ];
    (function(){
      const cats=["短视频点赞","应用安装","电商收藏","短视频关注","电商加购"];
      const plats=["抖音","小红书","淘宝","快手","京东"];
      const rejReasons=["素材含水印","链接不可达","任务条件与分类不符","缺少必要字段"];
      for(let i=0;i<20;i++){
        const total=[120,260,400,600,300][i%5];
        let done=[0,0,120,400,0][i%5];
        let pubAudit=["passed","pending","passed","passed","rejected"][i%5];
        let status=["running","draft","running","closed","draft"][i%5];
        let compAuditing=[5,0,0,0,0][i%5];
        let disputes={in:[1,0,0,0,0][i%5],processing:[0,0,0,0,0][i%5]};
        if(pubAudit==='pending'||pubAudit==='rejected'){status='draft';done=0;compAuditing=0;disputes={in:0,processing:0};}
        if(done>=total){done=total;status='closed';pubAudit='passed';}
        if((status==='paused'||status==='closed')&&pubAudit!=='passed'){pubAudit='passed';}
        TASKS.push({
          id:`T20250913${String(i+1).padStart(2,'0')}`,
          category:cats[i%5], platform:plats[i%5], publisher:`U9${100+i}`,
          total, done, status, pubAudit, compAuditing, disputes,
          bountyPer:[0.6,1.2,0.5,1.0,0.9][i%5],
          serviceFeeRate:[0.1,0.12,0.15,0.1,0.12][i%5], shareMgmt:[0.1,0.1,0.08,0.1,0.1][i%5],
          createdAt:`2025-09-${String(7+(i%5)).padStart(2,'0')}T0${i%9}:00:00Z`,
          deadlineHours:[24,48,72,72,36][i%5],
          rejectReason:(pubAudit==='rejected')?rejReasons[i%rejReasons.length]:""
        });
      }
    })();

    const el = id => document.getElementById(id);
    function fmtMoney(n){ return '¥'+Number(n).toFixed(2); }
    function pct(done,total){ return total?Math.round(done/total*100):0; }
    function platformStatus(t){
      if(t.pubAudit==='pending') return '待审核';
      if(t.pubAudit==='rejected') return '被驳回';
      if(t.status==='closed' || t.done>=t.total) return '已完成';
      return '进行中';
    }
    function clsByPlatStatus(s){return s==='待审核'?'badge-wait':s==='被驳回'?'badge-reject':s==='已完成'?'badge-done':'badge-run';}
    const PAGE_SIZE = 15;
    let filtered = TASKS.slice(0);
    let currentPage = 1;
    let CURRENT = null;

    function renderList(){
      const tbody = el('taskTbody'); tbody.innerHTML='';
      let disputeIn=0, disputeProc=0, pubPending=0, compAudit=0, running=0;
      filtered.forEach(t=>{ disputeIn+=t.disputes.in; disputeProc+=t.disputes.processing; pubPending+=(t.pubAudit==='pending'?1:0); compAudit+=(t.compAuditing>0?1:0); running+=(t.status==='running'?1:0); });
      el('kpiDispute').innerText=disputeIn; el('kpiProcessing').innerText=disputeProc; el('kpiPubAudit').innerText=pubPending; el('kpiCompAudit').innerText=compAudit; el('kpiRunning').innerText=running;

      const start=(currentPage-1)*PAGE_SIZE, pageItems=filtered.slice(start,start+PAGE_SIZE);
      el('totalCount').innerText = filtered.length;

      if(pageItems.length===0){
        const tr=document.createElement('tr'); tr.innerHTML='<td colspan="9" class="text-center text-muted py-5">暂无数据。</td>'; tbody.appendChild(tr);
      }else{
        pageItems.forEach(t=>{
          const rate = pct(t.done,t.total);
          const created = new Date(t.createdAt).getTime();
          const deadline = created + t.deadlineHours*3600*1000;
          const leftMs = deadline - Date.now();
          const leftHours = Math.max(0, Math.floor(leftMs/1000/60/60));
          const pStatus = platformStatus(t);
          const canForce = (t.pubAudit==='passed' && !(t.status==='closed' || t.done>=t.total));
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              <a href="javascript:void(0)" class="link-primary text-decoration-none truncate" title="${t.id}" data-modal="${t.id}">${t.id}</a>
              <div class="small text-muted truncate" title="${new Date(t.createdAt).toLocaleString()}">${new Date(t.createdAt).toLocaleString()}</div>
            </td>
            <td>
              <div class="fw-semibold truncate" title="${t.category}">${t.category}</div>
            </td>
            <td>
              <div class="fw-semibold truncate" title="${t.publisher}">${t.publisher}</div>
              <div class="small text-muted">发布</div>
            </td>
            <td class="cell-tight">
              <div class="d-flex justify-content-between small"><span>${t.done}/${t.total}</span><span>${rate}%</span></div>
              <div class="progress"><div class="progress-bar" style="width:${rate}%"></div></div>
            </td>
            <td><span class="${clsByPlatStatus(pStatus)}">${pStatus}</span></td>
            <td class="cell-tight">
              <span class="me-2">完成审核中：<b>${t.compAuditing}</b></span>
              <span class="me-2">异议中：<b>${t.disputes.in}</b></span>
              <span>处理中：<b>${t.disputes.processing}</b></span>
            </td>
            <td class="cell-tight">
              <div>单份赏金：${fmtMoney(t.bountyPer)}</div>
              <div class="fw-semibold">预计总赏金：${fmtMoney(t.total*t.bountyPer)}</div>
            </td>
            <td><span class="countdown ${leftHours<=6?'text-warning':''} ${leftHours<=0?'text-danger':''}">${leftHours}h</span></td>
            <td>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" data-flow="${t.id}"><i class="bi bi-diagram-3 me-1"></i>流水</button>
                <button class="btn btn-sm btn-outline-danger" data-force="${t.id}" ${canForce?'':'disabled'}><i class="bi bi-power"></i> 强行终止</button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        });
      }
      renderPager();
      tbody.querySelectorAll('[data-modal]').forEach(btn=>btn.addEventListener('click',()=>openTaskModal(btn.dataset.modal)));
      tbody.querySelectorAll('[data-flow]').forEach(btn=>btn.addEventListener('click',()=>openFlow(btn.dataset.flow)));
      tbody.querySelectorAll('[data-force]').forEach(btn=>btn.addEventListener('click',()=>openForceModal(btn.dataset.force)));
    }

    function renderPager(){
      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      const ul = document.getElementById('pager'); ul.innerHTML='';
      function add(page,label=page,active=false,disabled=false){
        const li=document.createElement('li'); li.className='page-item'+(active?' active':'')+(disabled?' disabled':'');
        li.innerHTML='<a class="page-link" href="javascript:void(0)">'+label+'</a>';
        li.addEventListener('click',()=>{ if(!disabled){ currentPage=page; renderList(); } });
        ul.appendChild(li);
      }
      add(Math.max(1,currentPage-1),'«',false,currentPage===1);
      for(let p=1;p<=totalPages;p++){ add(p,p,p===currentPage,false); }
      add(Math.min(totalPages,currentPage+1),'»',false,currentPage===totalPages);
    }

    function applyFilter(){
      const kw = el('kw').value.trim().toLowerCase();
      const cat = el('category').value;
      const platSt = el('platStatus').value;
      const sort = el('sortBy').value;
      
      const df = el('dateFrom'), dt = el('dateTo');
      const dFrom = df.dataset.userSet==='1' && df.value ? new Date(df.value).getTime() : null;
      const dTo = dt.dataset.userSet==='1' && dt.value ? new Date(dt.value).getTime()+86400000 : null;

      filtered = TASKS.filter(t=>{
        let ok = true;
        if(kw){ ok = t.id.toLowerCase().includes(kw) || (t.publisher||'').toLowerCase().includes(kw); }
        if(ok && cat){ ok = t.category===cat; }
        if(ok && platSt){ ok = platformStatus(t)===platSt; }
        if(ok && (dFrom||dTo)){
          const ct = new Date(t.createdAt).getTime();
          if(dFrom && ct<dFrom) ok=false;
          if(dTo && ct>=dTo) ok=false;
        }
        
        return ok;
      });

      filtered.sort((a,b)=>{
        if(sort==='completion') return (b.done/b.total) - (a.done/a.total);
        if(sort==='remain') return (b.total-b.done)-(a.total-a.done);
        if(sort==='amount') return (b.total*b.bountyPer)-(a.total*a.bountyPer);
        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
      });

      currentPage = 1;
      renderList();
    }

    function resetFilter(){
      ['kw','category','platStatus','sortBy'].forEach(id=>{ const n=el(id); if(n.tagName==='SELECT') n.selectedIndex=0; else n.value=''; });
      ['dateFrom','dateTo'].forEach(id=>{ const n=el(id); n.value=''; n.dataset.userSet='0'; });
      applyFilter();
    }

    function exportCSV(){
      const header = ['任务ID','分类','平台','发布用户','完成/总量','平台层级状态','完成审核中','异议中','处理中','单份赏金','创建时间'];
      const rows = filtered.map(t=>[t.id,t.category,t.platform,t.publisher,`${t.done}/${t.total}`,platformStatus(t),t.compAuditing,t.disputes.in,t.disputes.processing,t.bountyPer,t.createdAt]);
      const csv = header.join(',')+'\\n'+rows.map(r=>r.join(',')).join('\\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='tasks_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    let tmInstance = null;
    function openTaskModal(taskId){
      const t = TASKS.find(x=>x.id===taskId); if(!t) return;
      const pStatus = platformStatus(t);
      el('tmTaskId').innerText = t.id;
      el('tmPlatCat').innerText = `${t.platform}｜${t.category}`;
      el('tmPublisher').innerText = t.publisher;
      el('tmCreated').innerText = new Date(t.createdAt).toLocaleString();
      const deadline = new Date(new Date(t.createdAt).getTime() + t.deadlineHours*3600*1000);
      el('tmDeadline').innerText = deadline.toLocaleString();
      const rate = pct(t.done, t.total);
      el('tmStatus').innerText = `${pStatus} ｜ 完成率 ${rate}%`;
      el('tmQuota').innerText = `${t.done}/${t.total}`;
      el('tmBounty').innerText = `¥${t.bountyPer.toFixed(2)} ｜ ¥${(t.total*t.bountyPer).toFixed(2)}`;
      const badge = document.getElementById('tmStatusBadge'); badge.className = clsByPlatStatus(pStatus); badge.textContent = pStatus;
      const mEl = document.getElementById('taskModal');
      tmInstance = bootstrap.Modal.getOrCreateInstance(mEl); tmInstance.show();
    }

    function openDrawer(taskId){
      const t = TASKS.find(x=>x.id===taskId); if(!t) return;
      CURRENT = t;
      const pStatus = platformStatus(t);
      el('dPlatStatus').className = clsByPlatStatus(pStatus); el('dPlatStatus').textContent = pStatus;
      el('dTaskId').innerText = t.id;
      el('dCatPlat').innerText = `${t.category}｜${t.platform}`;
      el('dPublisher').innerText = t.publisher;
      const rate = Math.round(t.done/t.total*100);
      el('dProgressText').innerText = `${t.done}/${t.total}（${rate}%）`;
      el('dProgressBar').style.width = rate+'%';
      el('ovPlatform').innerText = t.platform; el('ovCategory').innerText = t.category;
      el('ovCreated').innerText = new Date(t.createdAt).toLocaleString();
      el('ovFormSummary').innerText = `单份赏金：¥${t.bountyPer.toFixed(2)}；信息费率：${Math.round(t.serviceFeeRate*100)}%；管理分成：${Math.round((t.shareMgmt||0.1)*100)}%`;
      const bountyTotal = t.total * t.bountyPer;
      const infoFee = bountyTotal * t.serviceFeeRate;
      const shareMgmt = t.shareMgmt || 0.1, shareWorker = 1 - shareMgmt;
      el('fdBounty').innerText = '¥'+bountyTotal.toFixed(2);
      el('fdInfoFee').innerText = '¥'+infoFee.toFixed(2);
      el('fdShare').innerText = `${Math.round(shareWorker*100)}% / ${Math.round(shareMgmt*100)}%`;
      const settledWorker = t.done * t.bountyPer * shareWorker;
      const settledMgmt = t.done * t.bountyPer * shareMgmt;
      const refund = (t.total - t.done) * t.bountyPer;
      el('fdSettle').innerText = `已结给执行：¥${settledWorker.toFixed(2)}；已结给管理：¥${settledMgmt.toFixed(2)}；待退发布者：¥${refund.toFixed(2)}`;

      renderTaskLog(t);
      renderAuditList(t);
      document.getElementById('drawer').classList.add('open');
    }
    document.getElementById('btnCloseDrawer').addEventListener('click',()=>document.getElementById('drawer').classList.remove('open'));

    function openFlow(taskId){
      const t = TASKS.find(x=>x.id===taskId); if(!t) return;
      CURRENT = t;
      el('flowTitle').innerText = `${t.id}｜${t.category}｜${t.platform}｜发布：${t.publisher}`;
      const pStatus = platformStatus(t);
      const badge = document.getElementById('flowStatusBadge');
      badge.className = clsByPlatStatus(pStatus); badge.textContent = pStatus;
      document.getElementById('flowStatusText').textContent = `完成 ${t.done}/${t.total}`;
      const rate = pct(t.done, t.total);
      document.getElementById('flowProgressBar').style.width = rate + '%';
      document.getElementById('flowProgressText').textContent = `完成率 ${rate}%`;

      renderFlow(buildFlowEvents(t));
      document.getElementById('flowDrawer').classList.add('open');
    }
    document.getElementById('btnCloseFlow').addEventListener('click',()=>document.getElementById('flowDrawer').classList.remove('open'));

    function genTaskLogEvents(t, baseTs){
      const arr = [];
      arr.push({type:'tasklog', ts: baseTs + 0*3600e3, icon:'bi-cloud-upload', title:'提交任务待审核', meta:`创建者：${t.publisher}`});
      if(t.pubAudit==='rejected'){
        arr.push({type:'tasklog', ts: baseTs + 2*3600e3, icon:'bi-slash-circle', title:'审核驳回', meta:`原因：${t.rejectReason || '不符合规范'}`});
        return arr;
      }
      if(t.pubAudit==='pending'){ return arr; }
      if(t.pubAudit==='passed'){
        arr.push({type:'tasklog', ts: baseTs + 3*3600e3, icon:'bi-play-circle', title:'审核通过 - 任务开始', meta:'已开放接单'});
        const endTs = baseTs + t.deadlineHours*3600e3;
        const finishedAll = t.done>=t.total;
        if(finishedAll){
          arr.push({type:'tasklog', ts: Math.min(endTs, baseTs + 30*3600e3), icon:'bi-check2-circle', title:'任务完成 - 领完终止', meta:`完成 ${t.done}/${t.total}`});
        }else if(t.status==='closed'){
          const reason = t.forcedCloseReason ? `；原因：${t.forcedCloseReason}` : '';
          arr.push({type:'tasklog', ts: t.forcedCloseTs || Math.min(endTs, baseTs + 40*3600e3), icon: t.forcedCloseTs ? 'bi-flag-fill':'bi-flag', title:`任务完成 - 平台终止${t.forcedCloseTs ? '（强制）':''}`, meta:`完成 ${t.done}/${t.total}${reason}`});
        }
      }
      return arr;
    }
    function genAuditRecords(t, baseTs){
      const records = [];
      if(t.pubAudit!=='passed') return records;
      const names = ['阿瑟','小林','Echo','Mina','老王','Kei','Luna','川川','Niko','Seven','Duke','Momo','小周','Tian','老李'];
      let nApproved = Math.min(t.done, 8);
      let nRejected = Math.min(Math.max(0, Math.floor((t.total - t.done)*0.05)), 3);
      let nDisputeIn = Math.min(t.disputes.in, 2);
      let nDisputeProc = Math.min(t.disputes.processing, 2);
      let idx=0;
      function push(name, label, icon, offsetH, extra=''){
        const ts = baseTs + offsetH*3600e3 + (idx%3)*1000;
        records.push({type:'audit', ts, icon, title:`作业审核 - ${label}`, meta:`用户：${name}（W${10000+idx}），凭证：截图#${1100+idx}，结果：${label}${extra? '，'+extra:''}，对应赏金：¥${(t.bountyPer).toFixed(2)}`});
        idx++;
      }
      for(let i=0;i<nApproved;i++) push(names[i%names.length],'已通过','bi-journal-check',8+i*2);
      for(let i=0;i<nRejected;i++) push(names[(i+3)%names.length],'已驳回','bi-x-octagon',10+i*3,'原因：不符合要求');
      for(let i=0;i<nDisputeIn;i++) push(names[(i+5)%names.length],'异议中','bi-exclamation-octagon',12+i*4);
      for(let i=0;i<nDisputeProc;i++) push(names[(i+7)%names.length],'处理异议中','bi-tools',14+i*4);
      for(let j=0;j<Math.min(3, t.compAuditing); j++) push(names[(j+9)%names.length],'审核中','bi-hourglass-split',18+j*2,`队列序号 #${j+1}`);
      return records;
    }
    function genFundEvents(t, baseTs){
      const arr = [];
      const totalBounty = t.total * t.bountyPer;
      const infoFee = totalBounty * t.serviceFeeRate;
      const shareMgmt = t.shareMgmt || 0.1, shareWorker = 1 - shareMgmt;
      const settledWorker = t.done * t.bountyPer * shareWorker;
      const settledMgmt = t.done * t.bountyPer * shareMgmt;
      const refund = (t.total - t.done) * t.bountyPer;

      arr.push({type:'fund', ts: baseTs + 1*3600e3, icon:'bi-safe2-fill', title:'发布冻结（赏金+发布信息费）', amount: +(totalBounty + infoFee), meta:`对象：从发布用户 ${t.publisher} 转入平台保证金`});

      if(t.pubAudit==='rejected'){
        arr.push({type:'fund', ts: baseTs + 3*3600e3, icon:'bi-arrow-counterclockwise', title:'审核驳回 - 解冻退回', amount: -(totalBounty + infoFee), meta:`对象：退回发布用户 ${t.publisher}`});
        return arr;
      }
      if(t.pubAudit==='pending'){ return arr; }

      arr.push({type:'fund', ts: baseTs + 4*3600e3, icon:'bi-receipt', title:'发布信息费解冻并转入发布团队', amount: -infoFee, meta:'对象：任务发布管理团队账户'});

      const baseSettleTs = t.forcedCloseTs ? t.forcedCloseTs : (baseTs + 36*3600e3);
      const reasonMeta = t.forcedCloseReason ? `（强制终止原因：${t.forcedCloseReason}）` : '';

      if(t.done>0){
        arr.push({type:'fund', ts: baseSettleTs + 1*3600e3, icon:'bi-cash-coin', title:'批量结算给执行用户', amount: -settledWorker, meta:`对象：多名执行用户（按 ${Math.round((1 - shareMgmt)*100)}% 分成）${reasonMeta}`});
        arr.push({type:'fund', ts: baseSettleTs + 2*3600e3, icon:'bi-wallet2', title:'结算给接单管理团队', amount: -settledMgmt, meta:`对象：任务接单管理团队（${Math.round(shareMgmt*100)}%）${reasonMeta}`});
      }
      if(refund>0){
        arr.push({type:'fund', ts: baseSettleTs + 3*3600e3, icon:'bi-arrow-return-left', title:'退回未完成/被驳回份额', amount: -refund, meta:`对象：退回发布用户 ${t.publisher}${reasonMeta}`});
      }
      return arr;
    }
    function buildFlowEvents(t){
      const base = new Date(t.createdAt).getTime();
      let arr = [];
      arr = arr.concat(genTaskLogEvents(t, base)).concat(genAuditRecords(t, base)).concat(genFundEvents(t, base));
      arr.sort((a,b)=>a.ts-b.ts);
      arr.forEach(e=>e.time = new Date(e.ts).toLocaleString());
      return arr;
    }
    function renderTaskLog(t){
      const base = new Date(t.createdAt).getTime();
      const list = genTaskLogEvents(t, base);
      const cont = document.getElementById('progressTimeline'); cont.innerHTML='';
      list.forEach(e=>{ const item = document.createElement('div'); item.className='mb-2'; item.innerHTML = `<div class="fw-semibold"><i class="bi ${e.icon} me-1"></i>${e.title}</div><div class="text-muted small">${e.meta}　|　${new Date(e.ts).toLocaleString()}</div>`; cont.appendChild(item); });
      if(list.length===0){ cont.innerHTML = '<div class="text-muted">暂无任务日志。</div>'; }
    }
    function renderAuditList(t){
      const base = new Date(t.createdAt).getTime();
      const list = genAuditRecords(t, base);
      const cont = document.getElementById('auditTimeline'); cont.innerHTML='';
      if(list.length===0){ cont.innerHTML = '<div class="text-muted">暂无作业审核记录（仅“审核通过”的任务会产生此类记录）。</div>'; return; }
      list.forEach(e=>{ const item = document.createElement('div'); item.className='mb-2'; item.innerHTML = `<div class="fw-semibold"><i class="bi ${e.icon} me-1"></i>${e.title}</div><div class="text-muted small">${e.meta}　|　${new Date(e.ts).toLocaleString()}</div>`; cont.appendChild(item); });
    }
    function renderFlow(list){
      const tl = document.getElementById('flowTimeline'); tl.innerHTML='';
      list.forEach(e=>{
        const div = document.createElement('div'); div.className='item'; div.dataset.type = e.type;
        const tags = {tasklog:'<span class="tl-tag"><i class="bi bi-activity"></i>任务日志</span>', audit:'<span class="tl-tag"><i class="bi bi-journal-check"></i>作业审核</span>', fund:'<span class="tl-tag"><i class="bi bi-currency-exchange"></i>资金</span>'}[e.type] || '';
        const amount = (typeof e.amount === 'number') ? ` <span class="tl-amount">${e.amount>=0?'+':''}¥${Number(e.amount).toFixed(2)}</span>` : '';
        div.innerHTML = `<div class="fw-semibold"><i class="bi ${e.icon} me-1"></i>${e.title}${amount}</div><div class="tl-meta small">${tags}${e.meta? '　'+e.meta : ''}　|　${e.time}</div>`;
        tl.appendChild(div);
      });
      document.querySelectorAll('.chip').forEach(c=>{
        c.addEventListener('click',()=>{
          document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
          c.classList.add('active');
          const tp = c.dataset.type;
          Array.from(tl.children).forEach(it=>{ it.style.display = (tp==='all' || it.dataset.type===tp) ? '' : 'none'; });
        });
      });
      document.getElementById('flowSearch').oninput = (ev)=>{
        const q = ev.target.value.trim();
        Array.from(tl.children).forEach(it=>{ const txt = it.innerText || it.textContent; it.style.display = txt.indexOf(q)>=0 ? '' : 'none'; });
      };
    }

    let forceModalInstance = null;
    function openForceModal(taskId){
      const t = TASKS.find(x=>x.id===taskId); if(!t) return;
      if(!(t.pubAudit==='passed' && !(t.status==='closed' || t.done>=t.total))) return;
      CURRENT = t;
      document.getElementById('forceReason').value = '';
      document.getElementById('forceHint').textContent = '';
      const modalEl = document.getElementById('forceModal');
      forceModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
      forceModalInstance.show();
      document.getElementById('forceConfirmBtn').onclick = ()=>{
        const reason = document.getElementById('forceReason').value.trim();
        if(reason.length < 10){
          const hint = document.getElementById('forceHint'); hint.textContent = '请输入不低于 10 个字的终止原因。'; hint.className = 'form-text text-danger'; return;
        }
        forceModalInstance.hide();
        applyForceClose(t.id, reason);
      };
    }
    function applyForceClose(taskId, reason){
      const t = TASKS.find(x=>x.id===taskId); if(!t) return;
      t.status = 'closed'; t.forcedCloseTs = Date.now(); t.forcedCloseReason = reason;
      renderList();
      const flowOpen = document.getElementById('flowDrawer').classList.contains('open');
      if(flowOpen && CURRENT && CURRENT.id===taskId){ openFlow(taskId); }
    }

    function init(){
      document.getElementById('sidebarToggle')?.addEventListener('click', function (){ document.querySelector('.sidebar')?.classList.toggle('show'); });
      document.getElementById('btnLogout')?.addEventListener('click', function(e){ e.preventDefault(); try{ localStorage.removeItem('auth_token'); localStorage.removeItem('user_info'); sessionStorage.clear(); }catch(err){} window.location.href = 'login.html'; });
      ['dateFrom','dateTo'].forEach(id=>{ const n=document.getElementById(id); n.value=''; n.dataset.userSet='0'; n.addEventListener('change',()=>n.dataset.userSet='1'); });
      document.getElementById('btnApply').addEventListener('click', applyFilter);
      document.getElementById('btnReset').addEventListener('click', resetFilter);
      document.getElementById('btnExport').addEventListener('click', exportCSV);
      applyFilter();
    }
    window.onerror = function(msg, src, line, col){ const bar = document.getElementById('debugBar'); bar.style.display='block'; bar.textContent='[JS错误] '+msg+' @'+line+':'+col; };
    document.addEventListener('DOMContentLoaded', init);
  </script>

<script>
// 侧边栏统一：插入“系统设置”（接口管理与监控下方），隐藏“数据概览/团队投诉反馈”
(function(){
  try{
    const aside = document.querySelector('aside.sidebar');
    if(aside){
      const links = aside.querySelectorAll('a');
      let apiLink = null, settingsLinkExists = false;
      links.forEach(a=>{
        if(a.textContent && a.textContent.includes('接口管理与监控')) apiLink = a;
        if(a.textContent && a.textContent.trim() === '系统设置') settingsLinkExists = true;
      });
      if(apiLink && !settingsLinkExists){
        const li = document.createElement('li'); li.className = 'nav-item';
        const a = document.createElement('a'); a.className='nav-link'; a.textContent='系统设置';
        a.href = 'hq-admin-settings-system_v1.2.1d_tabs.html';
        li.appendChild(a);
        const parentUl = apiLink.closest('ul') || aside.querySelector('ul');
        parentUl.insertBefore(li, apiLink.parentElement.nextSibling);
      }
      // 隐藏“数据概览”“团队投诉反馈”
      links.forEach(a=>{
        const t = (a.textContent||'').trim();
        if(t.includes('数据概览') || t.includes('团队投诉反馈')){
          const li = a.closest('li'); if(li) li.style.display='none';
        }
      });
    }
  }catch(e){ console.warn('侧边栏统一失败', e); }
})();
</script>


<script>
// 将表格中的编号（TSK/TPA/TFA/RCG/WDU/WDT/TF/UF/GF/FBK...）自动变为可点击链接
(function(){
  const map = {
    TSK: 'hq-admin-task-detail.html',
    TPA: 'hq-admin-audit-task-publish.html',
    TFA: 'hq-admin-audit-task-completion.html',
    RCG: 'hq-admin-finance-recharge-review.html',
    WDU: 'hq-admin-finance-withdrawal-review.html',
    WDT: 'hq-admin-finance-team-withdrawal-review.html',
    TF:  'hq-admin-finance-platform-fund-flow.html',
    UF:  'hq-admin-finance-user-fund-flow.html',
    GF:  'hq-admin-finance-team-fund-flow.html',
    FBK: 'hq-admin-users-feedback.html',
    CAT: 'hq-admin-settings-categories.html',
    FRM: 'hq-admin-form-design.html',
    APP: 'hq-admin-system-api-management-monitoring.html',
    MSG: 'hq-admin-users-feedback.html',
    LOG: 'hq-admin-audit-task-completion.html',
    U:   'hq-admin-users-list.html',
    G:   'hq-admin-team-list.html'
  };
  const re = /\b(TSK|TPA|TFA|RCG|WDU|WDT|TF|UF|GF|FBK|CAT|FRM|APP|MSG|LOG|U|G)\d{4,}(?:\s*\d{3,})?\b/g;
  function linkifyNode(node){
    if(node.children && node.children.length) return;
    const text = node.textContent;
    if(!text || !re.test(text)) return;
    const html = text.replace(re, (m)=>{
      const pref = m.match(/^[A-Z]+/)[0];
      const href = map[pref] || '#';
      const q = encodeURIComponent(m.replace(/\s+/g,''));
      return `<a href="${href}?id=${q}" class="text-decoration-underline">${m}</a>`;
    });
    const span = document.createElement('span'); span.innerHTML = html;
    node.replaceWith(span);
  }
  const targets = Array.from(document.querySelectorAll('td, span, div, p, li'));
  targets.forEach(linkifyNode);
})();
</script>


<style>
/* 统一状态样式 */
.unified-empty { text-align:center; padding:28px 12px; color:#6c757d; }
.unified-empty .icon { display:inline-block; width:36px; height:36px; border-radius:50%; border:2px dashed #ced4da; margin-bottom:6px; }
.unified-loading { position:relative; min-height:80px; }
.unified-loading:after {
  content:""; position:absolute; inset:0; background:
    linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.04) 50%, rgba(0,0,0,0) 100%);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer { 0%{background-position:-200% 0;} 100%{background-position:200% 0;} }
.unified-error { color:#dc3545; padding:8px 0; }

/* 统一筛选浮层 */
#unifiedFilterPanel {
  position: fixed; right: 16px; top: 84px; width: 360px; z-index: 1080;
  background: #fff; border: 1px solid #dee2e6; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.12);
  display:none;
}
#unifiedFilterPanel .hdr { padding: 10px 12px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
#unifiedFilterPanel .bd { padding: 12px; }
#btnUnifiedFilter { margin-left: 8px; }

/* 按钮意图颜色统一（基于文本） */
button, .btn { transition: filter .2s ease; }
.btn-intent-approve { background:#198754; color:#fff; border-color:#198754; }
.btn-intent-reject { background:#dc3545; color:#fff; border-color:#dc3545; }
.btn-intent-return { background:#ffc107; color:#212529; border-color:#ffc107; }
.btn-intent-pay { background:#0d6efd; color:#fff; border-color:#0d6efd; }

/* 可点击编号统一下划线（若页面未设置） */
a.id-link { text-decoration: underline; }
</style>

<script>
(function(){
  // ===== 读取系统设置（货币/精度/时区） =====
  const PUB_KEY = 'hq_sys_settings_v1_2_1d_published';
  let locale = { lang:'zh-CN', tz:'Asia/Shanghai', currency:'CNY', precision:2 };
  try{
    const cfg = JSON.parse(localStorage.getItem(PUB_KEY)||'{}');
    if(cfg.locale){
      locale.lang = cfg.locale.lang || locale.lang;
      locale.tz = cfg.locale.tz || locale.tz;
      locale.currency = cfg.locale.currency || locale.currency;
      locale.precision = parseInt(cfg.locale.precision||locale.precision,10);
    }
  }catch(e){}

  // ===== 统一筛选：在首个 .card-header 右侧添加“筛选”按钮 + 浮层 =====
  function ensureFilterUI(){
    if(document.getElementById('unifiedFilterPanel')) return;
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline-secondary btn-sm';
    btn.id = 'btnUnifiedFilter';
    btn.innerHTML = '<i class="bi bi-funnel me-1"></i>筛选';
    // 尝试挂到第一个 card-header 右侧
    const hdr = document.querySelector('.card .card-header') || document.querySelector('.d-flex.align-items-center.justify-content-between');
    if(hdr){ hdr.appendChild(btn); }
    else {
      // 顶部右上角浮动按钮（兜底）
      const fbtn = btn.cloneNode(true);
      fbtn.style.position='fixed'; fbtn.style.right='16px'; fbtn.style.top='20px'; fbtn.style.zIndex='1080';
      document.body.appendChild(fbtn);
    }

    const panel = document.createElement('div');
    panel.id = 'unifiedFilterPanel';
    panel.innerHTML = `
      <div class="hdr">
        <strong>通用筛选</strong>
        <button type="button" class="btn-close" id="btnUFclose"></button>
      </div>
      <div class="bd">
        <div class="mb-2">
          <label class="form-label">关键字</label>
          <input class="form-control" id="uf-key" placeholder="编号/手机号/名称">
        </div>
        <div class="mb-2">
          <label class="form-label">状态</label>
          <select class="form-select" id="uf-status">
            <option value="">全部</option>
            <option>待处理</option>
            <option>处理中</option>
            <option>已通过</option>
            <option>已驳回</option>
            <option>已完成</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">时间范围</label>
          <div class="d-flex gap-2">
            <input type="date" class="form-control" id="uf-from">
            <input type="date" class="form-control" id="uf-to">
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button class="btn btn-outline-secondary btn-sm" id="uf-reset">重置</button>
          <button class="btn btn-primary btn-sm" id="uf-apply">应用</button>
        </div>
      </div>
    `;
    document.body.appendChild(panel);

    document.body.addEventListener('click', function(e){
      if(e.target && (e.target.id==='btnUnifiedFilter')){
        const p = document.getElementById('unifiedFilterPanel');
        p.style.display = (p.style.display==='none' || !p.style.display) ? 'block' : 'none';
      }
      if(e.target && (e.target.id==='btnUFclose')){
        document.getElementById('unifiedFilterPanel').style.display = 'none';
      }
      if(e.target && (e.target.id==='uf-reset')){
        document.getElementById('uf-key').value='';
        document.getElementById('uf-status').value='';
        document.getElementById('uf-from').value='';
        document.getElementById('uf-to').value='';
        // 客户端演示：移除高亮
        document.querySelectorAll('.uf-hl').forEach(n=>n.classList.remove('uf-hl'));
      }
      if(e.target && (e.target.id==='uf-apply')){
        // Demo：仅做关键字高亮；实际项目应触发具体表格筛选逻辑
        const key = (document.getElementById('uf-key').value||'').trim();
        document.querySelectorAll('.uf-hl').forEach(n=>n.classList.remove('uf-hl'));
        if(key){
          const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
          const re = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
          let node; while(node = walker.nextNode()){
            if(re.test(node.nodeValue) && node.parentElement && node.parentElement.closest('table')){
              node.parentElement.classList.add('uf-hl');
            }
          }
        }
        document.getElementById('unifiedFilterPanel').style.display = 'none';
      }
    });

    const style = document.createElement('style');
    style.textContent = `.uf-hl{ background: rgba(255, 230, 0, .45); outline: 1px dashed #ffbf00; }`;
    document.head.appendChild(style);
  }

  // ===== 统一金额格式（根据表头关键字判列） =====
  function unifyAmountFormat(){
    const tables = Array.from(document.querySelectorAll('table'));
    const nf = new Intl.NumberFormat(locale.lang, { style:'currency', currency: locale.currency, minimumFractionDigits: locale.precision, maximumFractionDigits: locale.precision });
    tables.forEach(tb=>{
      const ths = Array.from(tb.querySelectorAll('thead th, thead td')).map(th => (th.textContent||'').trim());
      if(!ths.length) return;
      ths.forEach((txt, idx)=>{
        if(/金额|价|费|收款|打款|入账|出账/.test(txt)){
          Array.from(tb.querySelectorAll(`tbody tr`)).forEach(tr=>{
            const td = tr.children[idx]; if(!td) return;
            const raw = (td.textContent||'').replace(/[,￥$]/g,'').trim();
            const num = parseFloat(raw);
            if(!isNaN(num)){
              td.setAttribute('data-raw-amount', num);
              td.textContent = nf.format(num);
              td.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace';
              td.style.textAlign = 'right';
            }
          });
        }
      });
    });
  }

  // ===== 统一时间格式 =====
  function unifyTimeFormat(){
    const tables = Array.from(document.querySelectorAll('table'));
    const fmt = new Intl.DateTimeFormat(locale.lang, { timeZone: locale.tz, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
    tables.forEach(tb=>{
      const ths = Array.from(tb.querySelectorAll('thead th, thead td')).map(th => (th.textContent||'').trim());
      if(!ths.length) return;
      ths.forEach((txt, idx)=>{
        if(/时间|日期|创建|更新/.test(txt)){
          Array.from(tb.querySelectorAll(`tbody tr`)).forEach(tr=>{
            const td = tr.children[idx]; if(!td) return;
            const s = (td.textContent||'').trim();
            // 常见格式 "YYYY-MM-DD HH:mm[:ss]"
            const iso = s.replace(/(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2}(:\d{2})?)/, '$1T$2');
            const d = new Date(iso);
            if(!isNaN(+d)){
              td.title = d.toISOString();
              td.textContent = fmt.format(d);
              td.style.whiteSpace = 'nowrap';
            }
          });
        }
      });
    });
  }

  // ===== 空态填充（无数据时） =====
  function fillEmptyStates(){
    Array.from(document.querySelectorAll('table')).forEach(tb=>{
      const body = tb.querySelector('tbody'); if(!body) return;
      const hasRow = body.querySelector('tr');
      if(!hasRow){
        const colSpan = (tb.querySelectorAll('thead th').length || 1);
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan = colSpan; td.className='unified-empty';
        td.innerHTML = '<div class="icon"></div><div>暂无数据</div>';
        tr.appendChild(td); body.appendChild(tr);
      }
    });
  }

  // ===== 动作按钮意图着色（基于文本内容） =====
  function colorizeActionButtons(){
    const btns = Array.from(document.querySelectorAll('button, a.btn'));
    btns.forEach(b=>{
      const t = (b.textContent||'').trim();
      if(/通过|同意|Approve/i.test(t)) b.classList.add('btn-intent-approve');
      if(/驳回|拒绝|Reject/i.test(t)) b.classList.add('btn-intent-reject');
      if(/打回|退回|Return/i.test(t)) b.classList.add('btn-intent-return');
      if(/打款|已转账|Pay/i.test(t)) b.classList.add('btn-intent-pay');
    });
  }

  // ===== 启动顺序 =====
  document.addEventListener('DOMContentLoaded', function(){
    ensureFilterUI();
    unifyAmountFormat();
    unifyTimeFormat();
    fillEmptyStates();
    colorizeActionButtons();
  });
})();
</script>

</body>
</html>
